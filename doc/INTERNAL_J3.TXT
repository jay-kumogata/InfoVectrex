
             光速船(Vectrex HP3000)プログラミングノート
                      (Rev B - 21st March 1993)
                       (JA #3 - 2023年4月2日)


     著者   : Keith Wilkins
            (訳注：Keith Wilkins氏は、MAMEプロジェクトでも活躍している)
            : Jay Kumogata(日本語訳)


     メール : spike@trd.tmg.nec.co.jp  (1993年4月28日まで）
     Twitter : @jay_kumogata (日本語訳)
            (訳注：日本語訳への質問は、Keith Wilkins氏にはしないこと)

              この期日以降、私が一貫性をもって行動し、個人的なインター
              ネットアカウントを取得するまで、連絡が取れなくなる。長く
              ならないことを望む。

     更新履歴:

              Rev A: 14/03/93 K.W  -  1st Draft, incomplete.
              Rev B: 21/03/93 K.W  -  2nd Draft, incomplete.
              JA #1: 06/06/24 K.J  -  日本語訳 v0.1, 不完全.
              JA #2: 06/07/22 K.J  -  日本語訳 v0.2, 不完全.
              JA #3: 23/04/02 K.J  -  日本語訳 v0.3, 不完全.

     もし、本文書に誤り（技術/スペル/文法）があれば、その誤りの記述を
     メールください。次版でファイル修正する。すべてのスペル誤りには、
     著作権がある。

     新しい事項の追加や、前書きへの作者をクレジットは、歓迎する。

     以下のデバイスについて記述されたドキュメントを持っているか：

                光速船 DAC MC1408-P8
                6522PIA ソフトウェア/ハードウェア仕様
                AY-3-8192 ソフトウェア/ハードウェア仕様
                光速船EXEC ROMのソースコード

     これらのドキュメントがどこにあるか悩んでおり、本文の編纂を減速さ
     せている。よって、もしこれらのドキュメントを持っているか、どこで
     手に入るかを知っているのであれば、教えて欲しい。

     免責:

     この項目を追加しなければならないと思う。それは、私が望んでいるか
     らではなく、誰かが馬鹿なことをしてしまった時に、それを私の過失と
     いわれないためにである。

     注意 - CRT駆動ボードで生成される電圧は、非常に高く、危険である。
            もし、なにをすべきかを知らないのであれば、光速船ハードウェ
            アをいじくりまわしてはいけない。

     この情報を利用したいかなる結果についても、私は責任を持たない。ま
     た、ここ含まれる情報が正しいことを保障しない。
 

システムメモリマップ
~~~~~~~~~~~~~~~~~~~~

　チップ/お金/スペースを節約するため、光速船のメモリは、少し難解だが、
2つのチップしか使っていない。1つは、4つの2入力NANDゲートを含み、もう1
つは、4つの2入力ORゲートを含んでいる。これは、利用しているゲート数を考
慮すると、尊敬に値する仕事である。


    0000-7fff   カートリッジROM領域。CART線は、~Eによってゲートされる。
                ~Eは、ROMを有効にする出力に、直接与えられる信号を生成
                する(訳注：CART線、~Eについては、詳細不明)。このアド
                レス領域は、R/W線でゲートされず、直接カートリッジコネ
                クタに与えられる (R/W)

    8000-C7FF   未使用領域

    C800-CFFF   光速船RAM領域 1Kx8、ミラーリング2回(R/W)

    D000-D7FF   6522PIAレジスタ、ミラーリング128回(R/W)

    D800-DFFF   使用禁止。本領域への読み込み/書き込みにおいては、6522、
                および、RAMが選択される

    E000-FFFF   システムROM領域 8Kx8(R/W)

 

6522A
~~~~~

　このデバイスは、光速船の周辺デバイス(例：キーパッド、ベクトル生成器、
DAC、サウンドチップ、等)を、すべて制御するために使われている。

　ポートAは、バスとして使われており、DACへの入力、および、サウンドチッ
プへの入力ピンD0-D7に直接つながっている。DACは、このポート上にある値で
あれば、どんなものでも出力する。

　ポートBは、以下のように使われている。

    PB0 - SWITCH    スイッチ制御は、アナログ・マルチプレクサを有効化/
                    無効化する。ベクトル描画ハードウェアの記述を見よ

    PB1 - SEL0      マルチプレクサのチャンネル選択を制御。ベクトル描画
    PB2 - SEL1      ハードウェアの記述を見よ

    PB3 - BC1       AY-3-8192サウンドチップのチップ選択信号
    PB4 - BDIR      AY-3-8192サウンドチップの読込み/書込み信号

    PB5 - COMPARE   アナログジョイスティックの位置を比較するオペアンプ
                    からのフィードバック結果

    PB6 - ???       この制御線は、カートリッジコネクタに供給されている。
                    32Kより大きなカートリッジで、ROMバンクを選択するの
                    に使われている（らしい）。

    PB7 - ~RAMP     この制御線は、ベクトル描画ハードウェアの一部を制御。
                    アクティブロー信号

　6522Aは、いくつかの制御線を持っている。これらの制御線は、ハンドシェー
クするために使われたりするが、光速船では、ベクトル描画ハードウェアを制
御するために使われている。

    CA1 - IO7       この制御線は、AY-3-8192サウンドチップのIO7ラインに
                    接続されている。私の推測では、CPUへの割り込みを生
                    成するために使われていると思われる。IO7のより詳細
                    については、AY-3-8192の記述を参照のこと。

    CA2 - ~ZERO     ベクトル描画ハードウェアの一部を構成する積分器に接
                    続。この制御線は、それらの積分器を0にして(X、Yと
                    も)、ビームをCRT中央に戻す効果がある。アクティブ
                    ロー信号。詳細な情報は、ベクトル描画ハードウェアの
                    記述を見よ

    CB1 - 未接続

    CB2 - ~BLANK    このアクティブロー信号は、ベクトル描画ハードウェア
                    へのビーム信号をオン/オフさせる。再描画のために、
                    ビーム位置を変更する時に、ビームを消すのに使われる

 

ベクトル描画ハードウェア
~~~~~~~~~~~~~~~~~~~~~~~~

この文書が持っているえこひいきした性質について、あらかじめお詫びする。
もし、この文書があなたを無視しているのであれば、それはあなたを対象とし
ていないためである。本文書は、デジタル/アナログインタフェースの曖昧な
世界で道楽半分でやってない、計算機の知識がある人々を対象としている。

ここで、信号への参照として、ASSERTED、もしくは、ACTIVE状態という単語を
用いた場合、それはアクティブな状態について述べている。例えば、RAMPは、
ロー(ゼロ)の時、アクティブになり、ハイの時、非アクティブになる。
INACTIVE、もしくは、NEGATEDは、信号がアクティブ状態にないことを意味し
ている。どちらでアクティブ状態になるかは、それぞれの信号の記述を参照の
こと。

(訳注：日本語訳では、次のように訳した。ASSERTED→アクティブ化、ACTIVE
→アクティブ、NAGATED→非アクティブ化、INACTIVE→非アクティブ)

もし、ベクトル描画ブロックダイアグラム（vector.gif参照）の写しを持って
いれば、この章は理解しやすい。

ベクトル描画回路は、アナログ/デジタル混合回路であり、以下のパーツから
構成されている。以下の文書で、制御線(機能)をセット/クリアするという
記述があった時には、その機能に対応するハードウェアのセットアップ方法が
記述されている箇所に戻って参照すること。

1) DAC. (デジタル/アナログコンバータ)

        DACは、ベクトル部において、最も重要なパーツである。DACは、6522
        のポートAに直接接続されている(ポートAをセットアップ、書き込み
        する詳細な方法については、6522Aの記述を見よ)。DACは、8ビット
        のデジタル値を取り、その値に比例したアナログ信号へ変換する。


                DAC 出力ボルト = ( ポートA - オフセット ) x 定数

        DACの出力は、?.??ボルト単位で、+?.??ボルトから-?.??ボルトの値
        域を持っている。

        DACにはイネーブル制御が存在しないので、入力された値は、すべて
        変換されることに注意。DACの出力は、マルチプレクサへの入力、お
        よび、X軸の積分器の入力へ接続されている。DACへの入力であるポー
        トAは、AY-3-8192にも接続されているので、サウンドチップへの書き
        込み時には、BLANK、RAMP信号のいずれか/両方が、アクティブ化しな
        いように注意すること。さもなければ、CRT全体にごみを描画してし
        まうかもしれない。

2) マルチプレクサ(デジタル/アナログ混合)

        DACの出力は、マルチプレクサの入力へつながっている(マルチプレ
        クサICの半分は、この目的で使われており、もう半分は、ジョイパッ
        ドの電位差計のA/D変換に使われている)。マルチプレクサは、1入力
        を取り、4出力のうちに、1出力を選んで切り替える。入力信号は、同
        時に1つの出力信号としかつながらない。


        マルチプレクサは、3制御入力を持っている。1つ目は、6522Aの
        SWITCH線(ポートBのビット0に対応)である(このビットをセット/
        クリアする方法は、6522Aの記述を見よ)。この制御線をアクティブ
        化すると、ちょうど、機械式のスイッチが動かされるように、入力ピ
        ンが選択された出力ピンに接続される。また、非アクティブ化される
        と、入力と出力ピンは、お互いに完全に分離される。


        2つ目は、SEL0、SEL1の入力(それぞれ、6522のポートBのビット1、2
        に対応)である。ビット1、2は、結合されて、2ビットの数(0-3の範
        囲を示す)になる。マルチプレクサがアクティブ化された時(上記を
        参照)には、ビット1、2の入力は、どの出力ピンが入力ピンに接続さ
        れるかを決めるのに使われる。ベクトル・マルチプレクサで使われる
        ピン/チャネル番号は、以下で与えられる。


                0 - Y軸積分器チャネル

                1 - X軸、Y軸積分器のオフセット
		(訳注：上記の式のオフセットのこと)

                2 - Z軸(ベクトル輝度)レベル
                (訳注：ベクトルの明るさのこと)

                3 - Connected to sound output line via divider network
                (訳注：動作を正しく理解していないので、訳していない)


3) X軸積分器、Y軸積分器(アナログ)

	それぞれの積分器への入力の前に、アナログスイッチが存在する。こ
	のスイッチは、6522AのポートBのビット7から出ているRAMP信孫に接
	続している。スイッチが閉じている(RAMP=0)時には、積分器は入力
	されている値を積分していく。RAMPが非アクティブ化され、スイッチ
	が開くと、積分動作は行なわれず、積分器は現在の値を保持し続ける
	(ZERO機能を見よ)。出力は、以下のような形式にしたがう。


                     ^
                    |
               1    |
           -  ---   |  ( 入力値Vin - オフセット値Voffset ) dT   + 定数
              CxR   |
                    |
                   v

	X軸、Y軸積分器については、R=10000、C=0.01x10E-6となる。

	この値を代入すると、以下の通り。

	   出力値Vout = - ((10000 x (入力値Vin-オフセット値Voffset) 
		        x 積分時間) + 初期値)

        最大偏向電圧を+5Vから-5Vと仮定すると、ビームの動きを計算できる。
	これは、常に、前回のビーム位置からの相対的な動きである。したがっ
	て、ビームがどこに位置しているかを確認するためには、まず積分器
	をゼロ(ZERO)にすることでしか、確実に0,0に位置していることが
	確認できない。

           入力値(整数)IntInput = (DAC値 - 128) * (10/256)

           オフセット値(整数)IntOffset = (DAC値 - 128) * (10/256)

        ここで、10/256は、最大の振幅が10ボルトとし、それを256ステップ
        で分割して求められる。したがって、1ステップは、10/256ボルトで
        ある。-128するのは、DAC値をプラス/マイナスの値に変換するため
        である。

           ⊿X = - ((10000 x (IntInput-IntOffset) x 移動時間RAMPtime) 
            (or ⊿Y)

                 X = X + ⊿X

        光速船で利用できるスクリーン領域を8インチ(20.3センチ)と仮定
	する。これが、10ボルトの振幅と同じになる。

        (Note 8 inches is a guess, I dont have a vectrex screen to measure
         so please correct me if I'm wrong, also these firgures dont take
         into accound any overdrive of the screen area, and will therefore
         be slightly incorrect, though by how much I wouldnt like to say)


             X軸の位置 = X (ボルト) * 2.03 (センチ/ボルト)
              (or Y)

        この値は、またスクリーンの中心を0,0として参照している。

        積分器への電力供給は、+5ボルトから-5ボルトのアナログの電力供給
	である。いかに長く積分したとしても、供給限界を超えることはでき
	ない。つまり、非常に長く積分した時には、積分器は飽和する。大抵、
	積分時間、つまり、RAMP信号がアクティブになっている時間は、とて
	も短く、マイクロ秒かミリ秒のオーダである。


	では、振幅のすべて(10ボルト)を移動するのには、どのぐらい時間
	がかかるのだろうか。ここでは、オフセット値=0、初期値=0、飽和な
	しと仮定する。

		10 = - 10000 x -10 x 積分時間

                積分時間 = 100μs=0.1ms

	これは、画面の一方からもう一方までにまたがる、最大のベクトルを
	描画するものである。

		出力値Vout = X軸、Y軸の両方において-5Vから+5V


4) RAMP (デジタル、アクティブロー)

    上述の通り、RAMP信号は、積分器の積分時間を制御する。この制御線は、
    アクティブロー信号で、6522のポートBビット7に接続している。

5) ZERO (デジタル、アクティブロー)

    この制御線は、6522 CA2線に接続されている。この制御線をどのようにセッ
    トアップするかの情報は、6522の記述を見よ。RAMP同様に、これもアクティ
    ブロー信号である。積分動作中には、この制御線は、非アクティブ状態
    (HIGH)にセットされなければならない。

    この制御線がアクティブになると、積分器の出力は0Vにセットされ、ビー
    ムは画面中央に移動する。線描画シーケンスとして、積分器に値を書き込
    む前には、この制御線をアクティブ化すべきである。積分器の出力値は、
    小さなコンデンサに保持され、すこしずつ放電していく。つまり、ある一
    定の時間以上、積分器がRAMPモードにある時には、その出力はゆっくりと
    ゼロに落ちていく。したがって、一通りのベクトルを描画した後には、確
    実に座標を取得するために、一度ゼロにクリアするべきである。

6) Z座標信号(アナログ)

    この信号は、CRTのZ座標(輝度)を制御している。この信号は、マルチプ
    レクサをZ座標の設定にし、DACへ値を書き込むことでセットできる。また、
    この信号は、サンプル＆ホールド回路に接続されているので、マルチプレ
    クサを切り離したとしても、値を保持することができる。 

    積分器と同様に、サンプル＆ホールドも、ゼロに向かってゆっくりと移動
    するので、ときどき、再書き込みする必要である。もし、一定の明るさで
    描画したいのであれば、それぞれのオブジェクトを描画するたび、もしく
    は、画面リフレッシュのたびに、この値を書き込むというのが、よい考え
    である。もちろん、ベクトルごとに明るさを変えたいのであれば、とにか
    くそのたびに値を書き込まなければならない。

7) BLANK (デジタル、アクティブハイ)

    CRTビームの輝度を変更せずに、画面上の位置を変更するには、この制御
    線を利用し、一時的に、Z座標の信号をゼロにできる。このZ座標の信号を
    非アクティブ化した時には、前の値が復元される。



すべてをまとめると
~~~~~~~~~~~~~~~~~~

　上述の通り、ベクトル描画の主要な要素は、X軸、Y軸の積分器であり、Z軸
（輝度）は主要な要素ではなく、容易に理解できる。ここでは、技術的な話が
理解できない時のために、積分器システムを説明するたとえ話を用意した。

　まず、すべての電気系を、家庭にある水道の配管に変換する。すると、電圧
は水圧に、電流/電荷は水流になる。

　よって、DACは、水道栓になり、書き込む値は、水道栓に掛かっている水圧
になる。積分器は、水が溜まるタンクというように考えられる。画面上のビー
ムのずれは、タンク内の水量で計測できる。

　したがって、DAC値を設定するのは、タンクの入口に水圧を設定したことに
なる。RAMPスイッチは、水道栓のオン/オフを制御する。よって、水圧（DAC経
由でのX軸、Y軸積分器の値）が、より高くなると、より速く水がタンクに流れ込
み、水位がより速く上昇する。つまり、水位は、ベクトル位置に対応しており、
光速船は、X軸、Y軸という2つのタンクを持つことになる。


　ここで、水位を調整する方法が2通りあることが分かる。水圧と水道栓を開
いている時間量である。

　タンクには、半分のところに、ZEROと印がついている。ここでは、常にタン
クの半分から始める。そして、水を注いだ後、ZEROバルブを開くと、超過した
水が捨てられて、ゼロ（画面中央）に自動的に戻る。

　しかし、本システムには、ひねりがある。というのは、水道栓への入力とし
て、負の水圧を設定することができ、タンクから水を抜くことができるのだ。
よって、ZEROバルブを開くと、水が流れ込み、タンクの真ん中まで水位が戻る。
本システムには、いくつか小さな問題もある。タンクには穴が開いていて、水
が出て、ゆっくり真ん中の水位に戻る。また、水道栓への水圧もゆっくりと減
少するので、水を増減させるサイクルの前には、常にZEROをしてから、タンク
の水圧を設定しなければならない。

これは、CRTビームにより、画面上にベクトルを描画する時にも同様にする必
要がある。

 

ベクトル描画の方法
~~~~~~~~~~~~~~~~~~

　いままでの記述を読んだのであれば、すでにベクトル描画についてよい考え
が浮かんでいるとはずである。もしくは、本当に、これに興味がないのであれ
ば、ここを飛ばして結構。ベクトル描画の流れを以下に示す。

 ステップ   1   BLANKビットを0にセット。スクリーン上にゴミを垂れ流さな
                いようにするためには、これがセットされていなければなら
                ない

            2   ZEROビットを0にセットし、積分器をクリア

            3   RAMPビットを1にセット

            4   ZEROビットを1に戻す

            5   マルチプレクサを有効にして、Z座標を選択

            6   ベクトルの輝度をDAC書き込み

            7   X、Y座標の積分器オフセットを選択し、DACに値を書き込む。
	         この値を使うと、X、Y座標を上下左右に動かすことができる

     --->   8 この動作が描画(DRAW)、もしくは、位置変更(POSITION)の
    |         いずれかによって、BLANK線をセットする(訳注：描画の時に、
    |         BLANK線をセットする)
    |
    |       9 マルチプレクサ上でY座標を選択し、DACに対して、Y方向の速
    |         度を書き込み 
    |
    |       10  マルチプレクサを無効にする
    |
    |ループ 11  DACに対して、X方向の速度を書き込み
    |
    |       12  RAMP線を1にセット
    |
    |   < ここで、ベクトルが描画される >
    |
     ---    13  RAMP線を0にセット

        < ベクトル描画が終了 >

            14  CRT上になにも描画しないためには、BLANK線に0をセット

　上記のステップは、それぞれのオブジェクト、もしくは、画面全体について、
1ループで実行される。EXEC ROMが、どのような動作をしているかは分からな
いが、私としては、それぞれのオブジェクト毎に、ステップ1-14を実行してい
る。つまり、ループ8-13は、そのオブジェクトのコンポーネント毎の実行する。
最後に描画したオブジェクトを参照する(相対座標)よりも、原点を参照する
(絶対座標)ほうが、各オブジェクトの位置を確実に決めることができる。も
し、ゼロ化をしないと、エラー発生時に、オブジェクトが、ぐらぐらしたり、
揺れたりするかもしれない。

　もし、描画の前にベクトルの位置を変えるだけであれば、ステップ5、6は省
略できる。

　さて、ややこしいところが、やってきた。どうやって、X方向の速度、Y方向
の速度、X,Y座標積分器オフセットを計算するのか。また、RAMPパルスをどの
ぐらい長く生成するのか。

　画面が静止しているように見えるためには、RAMPパルスの長さが重要になる。
RAMPがアクティブ時に割り込みが発生すると、RAMPパルス長が変わってしまう
ので、ベクトル描画サイクル中は、割り込みを禁止しなければならない
(MUST)。

　私の知る限り、このシステムを動作させるには、3通りの方法がありうる。
すべての方法で、X,Y積分器オフセットは定数であることが仮定されており、
ズームイン/アウトも利用することができる。


1) (私見では)EXEC ROMに最も近い方法。まず、すべてのベクトルについて、
   RAMPパルスの固定長を持つ。8ビットDAC値で指定するため、X座標、Y座標
   の両方とも、255単位のベクトルの解像度を持つことなる。これは、画面の
   解像度が、256x256という意味ではない。RAMP時間とX,Y積分器オフセット
   の値により、255単位のベクトルは、非常に小さくなったり、非常に大きく
   なったりする。これは、すべては、最後の積分器の位置に対し、相対的に
   行なわれるためである(訳注：RAMP時間はベクトル長の拡大・縮小、X,Y積
   分器オフセットは平行移動の効果もつので、ベクトル描画ごとに、255単位
   の大きさが変わるという意味)。私は、この方法が、計算が最もすくない
   と見積もっている。RAMPを固定し、X,Y積分器オフセットにより、単位長を
   設定できる。

2) まず、移動したい方向に応じたX,Y方向の値をルックアップ表(計算によっ
   て求めることも可)として持つ。これらの値は、ひとつの固定ベクトル単
   位長で、規定されている。必要なベクトル長を生成するためには、RAMP長
   か、X,Y積分器オフセットを変更することを選択できる。ちょうど、X,Y積
   分器に設定した値と、固定単位長を掛け算することで、必要なベクトル長
   を得ることができる。

3) 最も複雑な方法。すべての変数を変更する。しかし、これをどう計算する
   かは、神のみぞ知ることだ。4変数もあるのだからね。

　方法1)、2)は、計算すべき変数の数が限られているので、最も見込みがある。
RAMPとして固定値を使うことが、最も簡単な方法である。これは、要求されて
いるRAMP設定するのに必要なCPUサイクルを数えるという問題を避けられるた
めである。RAMP時間の決定は、きちんと制御する必要がある。これは、不恰好
な方法だが、特にハードウェアタイマがない場合でも、ソフトウェアで実現で
きないことはない。

　光速船、開発ツールを使ってテストコードを書かなければ、この理論は検証
して、DAC値、時間から画面位置への変換を達成することはできない。私は、
画面上の最大ねじれ電圧がどのぐらいかを知らないので、積分器の最大/最少
値が、画面ねじれの最大/最小値に対応していると仮定している。もしくは、
最大/最小値は画面外かもしれない。でも、どのぐらいか？

警告：ベクトルねじれ回路の内部周辺の電圧を調べてはいけない。論理ボード
は、低電圧回路しか含んでいないが、ベクトルねじれ回路用の電圧チョッパは、
5000ボルト当りの電圧を生成する。あなたは、警告されました。

EXEC ROMを逆アセンブルする時間がある時に、EXEC ROMがどのようにベクトル
を描画するかを片付けることできる。
（訳注：EXEC ROMを逆アセンブルしないで、この文書を記述しているのは、驚
きですね）
